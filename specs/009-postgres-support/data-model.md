# Data Model: PostgreSQL Database Support

**Branch**: `009-postgres-support` | **Date**: 2026-02-22

## Schema

The PostgreSQL adapter uses the identical document-store schema as SQLite, with `jsonb` replacing `TEXT` for the data column.

### `records` table

| Column | SQLite Type | PostgreSQL Type | Description |
|--------|------------|-----------------|-------------|
| `id` | `TEXT PRIMARY KEY` | `TEXT PRIMARY KEY` | UUID, generated by application |
| `tenant_id` | `TEXT NOT NULL` | `TEXT NOT NULL` | Tenant scope identifier |
| `collection` | `TEXT NOT NULL` | `TEXT NOT NULL` | Logical collection name |
| `data` | `TEXT NOT NULL` | `JSONB NOT NULL` | Document payload |
| `created_at` | `TEXT NOT NULL` | `TIMESTAMPTZ NOT NULL` | ISO 8601 timestamp |
| `updated_at` | `TEXT NOT NULL` | `TIMESTAMPTZ NOT NULL` | ISO 8601 timestamp |

### Indexes

| Index | Columns | Purpose |
|-------|---------|---------|
| `idx_records_tenant_collection` | `(tenant_id, collection)` | Primary query path â€” all queries filter by tenant + collection |

### SQL (PostgreSQL)

```sql
CREATE TABLE IF NOT EXISTS records (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  collection TEXT NOT NULL,
  data JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_records_tenant_collection
  ON records (tenant_id, collection);
```

## Query Mapping: SQLite to PostgreSQL

| Operation | SQLite | PostgreSQL |
|-----------|--------|------------|
| JSON field access | `json_extract(data, '$.field')` | `data->>'field'` |
| Insert data | `JSON.stringify(record)` as TEXT | Record object (postgres.js serializes to jsonb) |
| Read data | `JSON.parse(row.data)` | Direct object (postgres.js deserializes jsonb) |
| Parameterized query | `?` placeholders | `$1`, `$2` numbered params (handled by tagged templates) |
| Transaction begin | `db.exec("BEGIN")` | `sql.begin(async (sql) => { ... })` |
| LIMIT without OFFSET | `LIMIT ?` | `LIMIT $N` |
| OFFSET without LIMIT | `LIMIT -1 OFFSET ?` | `OFFSET $N` (no LIMIT needed) |

## Entity Relationships

No changes to entity relationships. All existing collections (`training_sessions`, `training_modules`, `role_profiles`, `employees`, `evidence`, `audit_events`, `compliance_uploads`) continue to use the same `records` table with tenant-scoped row-level isolation.

## Adapter Factory

```
Environment
  DATABASE_URL set with postgres:// prefix?
    Yes -> PostgresAdapter (connection pool)
    No  -> SQLiteAdapter (file-based)
  Both return -> Shared singleton used by all routes
```
