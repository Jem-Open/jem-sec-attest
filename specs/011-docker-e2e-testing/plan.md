# Implementation Plan: Docker Local Environment & E2E Testing

**Branch**: `011-docker-e2e-testing` | **Date**: 2026-02-23 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/011-docker-e2e-testing/spec.md`

## Summary

Add a production-mode Docker Compose stack (Next.js app + Dex IDP + PostgreSQL) and a Playwright CLI test suite covering the full `acme-corp` tenant user journey: OIDC sign-in → training intake → training modules → evidence export. Dex is configured with a static `alice@acme.com` test user and the `acme-corp` tenant YAML is extended with env-var-based OIDC settings. The Next.js app is built with `output: "standalone"` for a minimal production image. Playwright runs from the host machine via `pnpm test:e2e`.

## Technical Context

**Language/Version**: TypeScript 5.7, Node.js 20.9+
**Primary Dependencies**:
- Next.js 16.x (existing) — `output: "standalone"` added
- `@playwright/test` ^1.50.x — new dev dependency
- `dexidp/dex:v2.41.1` — Docker image (no npm dep)
- `postgres:16-alpine` — Docker image (no npm dep)
- `openid-client` v6.x (existing) — OIDC discovery and token exchange

**Storage**: PostgreSQL 16 via `PostgresAdapter` (existing); schema auto-initialised by `adapter.initialize()` on first connection

**Testing**:
- Playwright CLI (`pnpm test:e2e`) — E2E tests on host machine against running Docker stack
- Existing Vitest unit/integration/contract tests unchanged

**Target Platform**: Docker Linux containers; developer host machine (Mac, Linux)

**Performance Goals**:
- Stack startup in < 3 minutes (cold start including image build)
- `pnpm docker:up` blocks until all services are healthy

**Constraints**:
- One-time `/etc/hosts` entry (`127.0.0.1 dex`) required on developer machine — documented in quickstart
- No TLS; local HTTP only
- `better-sqlite3` still listed in `serverExternalPackages` for non-Docker usage; Docker stack uses PostgreSQL

**Scale/Scope**: Local development only; single `acme-corp` tenant; no CI integration in this feature

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|---|---|---|
| I. Configuration-as-Code | ✅ Pass | Dex config in `docker/dex/config.yaml`, tenant OIDC via env vars in YAML. No admin UI. |
| II. Deterministic/Audit | ✅ Pass | This feature is infra/testing; no change to AI or evidence logic. |
| III. Security-First / Tenant Isolation | ✅ Pass | Dex is local-only; no connection to production. Tenant scoping unchanged. |
| IV. Minimal Data Collection | ✅ Pass | No new persistence. Test data is ephemeral (in-memory Dex, volume-backed PG reset on `docker:down`). |
| V. Pluggable Architecture | ✅ Pass | Uses existing `PostgresAdapter` via `DATABASE_URL`. No hard-coded hosting assumptions. |
| VI. Accessibility | ✅ Pass | No new UI components. |
| VII. Quality Gates | ✅ Pass | This feature IS the quality gate improvement — E2E suite covering critical path. |
| VIII. Documentation Required | ✅ Pass | `quickstart.md` ships with the feature. Security guidance included. |
| IX. Technology Stack | ✅ Pass | Next.js 16.x, Vercel AI SDK unchanged. `@playwright/test` is a dev dependency. |
| Apache 2.0 License | ✅ Pass | All new source files must include the license header. |

**Complexity Tracking**: No constitution violations requiring justification.

## Project Structure

### Documentation (this feature)

```text
specs/011-docker-e2e-testing/
├── plan.md              # This file
├── research.md          # Phase 0 — IDP, hostname, Playwright, Docker decisions
├── data-model.md        # Phase 1 — service topology, config entities
├── quickstart.md        # Phase 1 — developer setup guide
├── contracts/
│   └── health.openapi.yaml  # Phase 1 — health endpoint contract
└── tasks.md             # Phase 2 — generated by /speckit.tasks
```

### Source Code (repository root)

```text
root/
├── Dockerfile                              # new
├── .dockerignore                           # new
├── docker/
│   ├── compose.yml                         # new
│   └── dex/
│       └── config.yaml                     # new
├── next.config.ts                          # modified
├── playwright.config.ts                    # new
├── package.json                            # modified (scripts + @playwright/test)
├── app/
│   └── api/
│       └── health/
│           └── route.ts                    # new
├── config/
│   └── tenants/
│       └── acme-corp.yaml                  # modified (add auth.oidc section)
├── tests/
│   └── e2e/
│       ├── .auth/                          # gitignored (runtime)
│       │   └── user.json                   # generated by auth.setup.ts
│       ├── fixtures/
│       │   └── auth.ts                     # new
│       ├── auth.setup.ts                   # new
│       ├── journey.spec.ts                 # new
│       └── tsconfig.json                   # new
├── .env.docker.example                     # new
└── .env.example                            # modified (add ACME_OIDC_* vars)
```

**Structure Decision**: Single project layout (Option 1). E2E tests extend the existing `tests/` tree under `e2e/`, consistent with existing `unit/`, `integration/`, `contract/` directories.

---

## Phase 0: Research

All unknowns resolved. See [research.md](./research.md).

| Decision | Outcome |
|---|---|
| Test IDP | `dexidp/dex:v2.41.1` with `staticPasswords` |
| OIDC hostname strategy | Service name `dex` + `/etc/hosts: 127.0.0.1 dex` |
| Next.js Docker build | `output: "standalone"` + two-stage Dockerfile |
| Playwright approach | Host machine CLI, `tests/e2e/`, `playwright.config.ts` at root |
| Tenant OIDC config | Env-var extension of `config/tenants/acme-corp.yaml` |
| Health check | Custom `/api/health` route, `force-dynamic` |
| PostgreSQL schema | Auto-initialised by `PostgresAdapter.initialize()` |
| Service ordering | `depends_on: condition: service_healthy` |

---

## Phase 1: Design

### Step 1 — Dockerfile (multi-stage Next.js standalone)

**File**: `Dockerfile`

Two stages:
1. **builder** (`node:20-alpine`): installs pnpm, copies source, runs `pnpm install --frozen-lockfile`, runs `pnpm build`, copies `public/` and `.next/static/` into `.next/standalone/`
2. **runner** (`node:20-alpine`): installs `curl` (for health check), creates non-root `nodejs:1001` user, copies only `.next/standalone/` from builder, sets `NODE_ENV=production PORT=3000 HOSTNAME=0.0.0.0`, exposes 3000, runs `node server.js`

**HEALTHCHECK**: `CMD curl -f http://localhost:3000/api/health || exit 1`

### Step 2 — .dockerignore

**File**: `.dockerignore`

Exclude: `.git`, `node_modules`, `.next`, `coverage`, `test-results`, `dist`, `.env*`, `*.md`, `specs/`, `.specify/`, `tests/`

### Step 3 — docker/dex/config.yaml

**File**: `docker/dex/config.yaml`

```
issuer: http://dex:5556/dex
storage: { type: memory }
web: { http: 0.0.0.0:5556 }
enablePasswordDB: true
oauth2: { skipApprovalScreen: true }
staticClients:
  - id: jem-app
    secret: <from ACME_OIDC_CLIENT_SECRET env var — templated>
    redirectURIs: ["http://localhost:3000/api/auth/acme-corp/callback"]
    name: "JEM Attestation (local)"
staticPasswords:
  - email: alice@acme.com
    hash: <bcrypt of "Acme1234!">
    username: alice
    userID: acme-test-001
```

> **Note**: The client secret in `config.yaml` is a literal value (Dex does not support env var substitution). It must match `ACME_OIDC_CLIENT_SECRET` in `.env.docker`. The `config.yaml` is NOT committed with a real secret — a placeholder comment instructs developers to replace it, or the secret is templated at compose startup.

**Implementation approach**: Use Docker Compose `environment` to pass `ACME_OIDC_CLIENT_SECRET` and a Docker Compose `entrypoint` that uses `sed` or `envsubst` to substitute the secret into the config before Dex starts. Alternatively, use a separate `docker/dex/config.yaml.template` and generate the final config in the Compose `command`.

Simpler approach (recommended): Commit `docker/dex/config.yaml` with a placeholder secret that matches the documented default in `.env.docker.example`. Developers who need a different secret update it manually. Since this is local-only, the risk is minimal and documented.

### Step 4 — docker/compose.yml

**File**: `docker/compose.yml`

```yaml
services:
  postgres:
    image: postgres:16-alpine
    environment: { POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB }
    healthcheck: pg_isready every 10s, 5 retries, 30s start_period
    networks: [jem_local]

  dex:
    image: dexidp/dex:v2.41.1
    ports: ["5556:5556", "5558:5558"]
    volumes: ["./dex/config.yaml:/etc/dex/config.yaml:ro"]
    command: dex serve /etc/dex/config.yaml
    healthcheck: wget -qO- http://localhost:5556/dex/.well-known/openid-configuration every 10s, 3 retries, 15s start_period
    networks: [jem_local]

  app:
    build: { context: .., dockerfile: ../Dockerfile }
    ports: ["3000:3000"]
    env_file: [../.env.docker]
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://..@postgres:5432/jem_attest
      ACME_OIDC_ISSUER_URL: http://dex:5556/dex
      ACME_OIDC_CLIENT_ID: jem-app
      ACME_OIDC_REDIRECT_URI: http://localhost:3000/api/auth/acme-corp/callback
    healthcheck: curl -f http://localhost:3000/api/health every 30s, 3 retries, 40s start_period
    depends_on:
      postgres: { condition: service_healthy }
      dex: { condition: service_healthy }
    networks: [jem_local]

networks:
  jem_local: { driver: bridge }
```

> **Context path**: The `build.context` is `..` (repo root) since `compose.yml` lives in `docker/`. The `Dockerfile` is at the repo root.

### Step 5 — next.config.ts (modify)

Add to the existing config object:
- `output: "standalone"`
- Add `"postgres"` to `serverExternalPackages` alongside existing `"better-sqlite3"`

### Step 6 — app/api/health/route.ts (new)

Apache 2.0 header required. Key implementation:
- `export const dynamic = "force-dynamic"`
- `GET` handler returns `{ status: "healthy", timestamp, uptime }` with HTTP 200
- On any unhandled error, returns `{ status: "unhealthy", error }` with HTTP 503
- No database check in initial implementation — startup errors surface in container logs

### Step 7 — config/tenants/acme-corp.yaml (modify)

Add under `settings:`:
```yaml
  auth:
    oidc:
      issuerUrl: "${ACME_OIDC_ISSUER_URL}"
      clientId: "${ACME_OIDC_CLIENT_ID}"
      clientSecret: "${ACME_OIDC_CLIENT_SECRET}"
      redirectUri: "${ACME_OIDC_REDIRECT_URI}"
      scopes:
        - openid
        - profile
        - email
```

### Step 8 — .env.docker.example (new)

Document all Docker-specific env vars with safe defaults and generation instructions:

```
# Docker local stack environment
# Copy to .env.docker and fill in secrets

# Database (used by app container; postgres:// triggers PostgresAdapter)
DATABASE_URL=postgres://postgres:postgres@postgres:5432/jem_attest
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=jem_attest

# Session encryption (minimum 32 characters)
SESSION_SECRET=<generate with: node -e "...">

# OIDC (Dex local IDP — must match docker/dex/config.yaml)
ACME_OIDC_CLIENT_SECRET=local-dev-secret-replace-with-32-chars

# AI provider (at least one required)
ANTHROPIC_API_KEY=<your-anthropic-api-key>

# Tenant webhook (optional for local testing)
ACME_WEBHOOK_SECRET=local-webhook-secret
```

### Step 9 — .env.example (modify)

Add `ACME_OIDC_*` variable documentation under the existing database section.

### Step 10 — playwright.config.ts (new)

At repo root. Key settings:
- `testDir: "./tests/e2e"`
- `fullyParallel: false` (OIDC sessions are stateful; avoid race conditions)
- `retries: 0`
- `use.baseURL: "http://localhost:3000"`
- `use.screenshot: "only-on-failure"`
- `use.trace: "on-first-retry"`
- `use.video: "retain-on-failure"`
- `outputDir: "test-results"`
- `globalSetup: "./tests/e2e/auth.setup.ts"` — runs once before all tests
- Single project: `chromium`

### Step 11 — tests/e2e/auth.setup.ts (new)

Apache 2.0 header. Global setup that:
1. Launches a browser context (via Playwright's `chromium.launch()`)
2. Navigates to `http://localhost:3000/api/auth/acme-corp/signin`
3. Waits for redirect to Dex (`waitForURL(/dex:5556/)`)
4. Fills `input[type="email"]` with `alice@acme.com` and `input[type="password"]` with `Acme1234!`
5. Clicks the login button
6. Waits for redirect back to `http://localhost:3000`
7. Saves `storageState` to `tests/e2e/.auth/user.json`

### Step 12 — tests/e2e/fixtures/auth.ts (new)

Apache 2.0 header. Extends Playwright's `test` with an `authenticatedPage` fixture that loads `storageState` from `tests/e2e/.auth/user.json` before each test.

### Step 13 — tests/e2e/journey.spec.ts (new)

Apache 2.0 header. Uses the `authenticatedPage` fixture. Test structure:

```
describe("acme-corp full user journey")
  test("sign-in establishes authenticated session")
    - navigate to /acme-corp
    - verify user is not redirected to sign-in
    - verify page title or nav element shows authenticated state

  test("training intake — role profile generation")
    - navigate to /acme-corp/intake
    - submit intake form with test job description
    - wait for AI-generated role profile to appear
    - confirm profile and proceed

  test("training modules — complete all modules")
    - navigate to /acme-corp/training/session
    - for each module: answer questions, submit, advance
    - verify session reaches completed state

  test("evidence export — download PDF")
    - navigate to completed session export page
    - trigger export
    - verify download response (check Content-Type or file availability)
```

> **Playwright CLI note**: Tests use Playwright's `test` and `expect` APIs from `@playwright/test`. Run via `pnpm exec playwright test` or `pnpm test:e2e`.

### Step 14 — tests/e2e/tsconfig.json (new)

TypeScript config extending root `tsconfig.json` with `include: ["**/*.ts"]`.

### Step 15 — package.json (modify)

Add to `scripts`:
```json
"test:e2e": "playwright test",
"docker:up": "docker compose -f docker/compose.yml up --build --wait",
"docker:down": "docker compose -f docker/compose.yml down -v"
```

Add to `devDependencies`:
```json
"@playwright/test": "^1.50.0"
```

### Step 16 — .gitignore (modify)

Add:
```
tests/e2e/.auth/
.env.docker
```

### Step 17 — Agent context update

Run `.specify/scripts/bash/update-agent-context.sh claude` to register new technologies.

---

## Implementation Order

Tasks should be implemented in this sequence (each is independently testable):

1. **Health route** (`app/api/health/route.ts`) — enables Docker healthcheck, no external deps
2. **next.config.ts** — standalone output, verified with `pnpm build`
3. **Dockerfile + .dockerignore** — build the image, verified with `docker build .`
4. **Dex config** (`docker/dex/config.yaml`) — IDP configuration
5. **Tenant OIDC config** (`config/tenants/acme-corp.yaml`) — OIDC settings
6. **Environment files** (`.env.docker.example`, update `.env.example`)
7. **docker/compose.yml** — full stack, verified with `pnpm docker:up`
8. **package.json** — add `@playwright/test` and scripts, `pnpm install`
9. **playwright.config.ts** — Playwright configuration
10. **E2E auth setup** (`tests/e2e/auth.setup.ts`) — global auth fixture
11. **E2E fixtures** (`tests/e2e/fixtures/auth.ts`) — test fixtures
12. **E2E journey tests** (`tests/e2e/journey.spec.ts`) — full journey (use playwright-cli skill)
13. **tests/e2e/tsconfig.json** — TypeScript config for e2e
14. **.gitignore** — add `.auth/` and `.env.docker`
15. **Agent context** — run update script

---

## Verification

After implementation, all of the following must pass:

```bash
# Existing tests still pass
pnpm test

# Stack starts successfully
pnpm docker:up
# All three services show "healthy" in: docker compose -f docker/compose.yml ps

# E2E suite passes
pnpm test:e2e

# Stack tears down cleanly
pnpm docker:down

# TypeScript check passes
pnpm type-check

# Lint passes
pnpm lint
```
