# Research: Compliance Evidence Integration

**Date**: 2026-02-21
**Branch**: `007-evidence-integration`

## R1: Sprinto Evidence Upload API

**Decision**: Use Sprinto's GraphQL multipart upload mutation `UploadWorkflowCheckEvidence` to upload evidence as PDF files.

**Rationale**: Sprinto's API is GraphQL-only (no REST endpoints). Evidence must be uploaded as a file attachment (PDF) via the GraphQL multipart request spec. The platform already has `renderEvidencePdf()` that produces PDF buffers from evidence records, so the integration can reuse this directly.

**Alternatives considered**:
- REST API: Not available — Sprinto only exposes GraphQL.
- Upload structured JSON: Not supported — Sprinto requires file uploads in specific formats (.pdf, .doc, .xlsx, etc.).
- Use a third-party Sprinto SDK: No official Node.js SDK exists. The GraphQL multipart request is straightforward to implement with standard `fetch` and `FormData`.

**Key API details**:

| Property | Value |
|----------|-------|
| Endpoint (US) | `https://app.sprinto.com/dev-api/graphql` |
| Endpoint (EU) | `https://eu.sprinto.com/dev-api/graphql` |
| Endpoint (India) | `https://in.sprinto.com/dev-api/graphql` |
| Auth | `api-key` HTTP header (static API key) |
| Mutation | `UploadWorkflowCheckEvidence` |
| Arguments | `workflowCheckPk: UUID!`, `evidenceRecordDate: DateTime!`, `evidenceFile: Upload!` |
| File format | PDF (already generated by `renderEvidencePdf`) |
| Transport | GraphQL multipart request spec (multipart/form-data) |
| Success response | `{ message, workflowCheck { evidenceStatus } }` where `evidenceStatus = "UPLOAD_COMPLETE"` |

**Error classification**:

| Error | Retryable | Source |
|-------|-----------|--------|
| HTTP 429 Too Many Requests | Yes | Rate limit |
| HTTP 5xx | Yes | Server error |
| Network timeout / ECONNREFUSED | Yes | Transient |
| HTTP 401 Unauthorized | No | Invalid API key |
| GraphQL error: "Incorrect check ID" | No | Bad `workflowCheckPk` |
| GraphQL error: "Check in review" | No | Check locked for review |
| GraphQL error: "Unsupported file format" | No | Should not occur (PDF is supported) |

## R2: Tenant Configuration Schema Extension

**Decision**: Extend `TenantSettingsSchema.integrations` with a new `compliance` block containing provider-specific configuration.

**Rationale**: The existing `integrations` object in the config schema is `.strict()`, so any new fields must be added to the Zod schema. The existing pattern for secrets (`${VAR}` env var references with regex enforcement, as used for OIDC `clientSecret`) should be reused for the Sprinto API key.

**Alternatives considered**:
- Use `settings.features` boolean flag only: Insufficient — need to store `workflowCheckPk`, `apiKeyRef`, and regional endpoint URL.
- Separate config file per integration: Over-engineering for a single optional block. The existing per-tenant YAML merge already handles this cleanly.

**Config shape**:

```yaml
# In tenant YAML: settings.integrations.compliance
integrations:
  compliance:
    provider: "sprinto"           # Discriminator for pluggable providers
    apiKeyRef: "${ACME_SPRINTO_API_KEY}"  # Env var reference (same pattern as OIDC clientSecret)
    workflowCheckId: "uuid-here"  # Sprinto workflow check PK (UUID)
    region: "us"                  # us | eu | india — determines endpoint URL
    retry:
      maxAttempts: 5              # Default 5
      initialDelayMs: 5000       # Default 5000
      maxDelayMs: 300000         # Default 300000 (5 min)
```

## R3: Integration Hook Point

**Decision**: Dispatch compliance upload after `evidenceRepo.create()` inside `generateEvidenceForSession()`, as a chained fire-and-forget async call.

**Rationale**: The evidence generator already has its own SQLite connection and runs as fire-and-forget. Adding the compliance dispatch here keeps the entire evidence lifecycle (generate → persist → upload) in a single flow. The retry chain runs within this same async context.

**Alternatives considered**:
- Event emitter on `EvidenceRepository.create()`: Adds indirection and testing complexity for no benefit — there's exactly one consumer.
- Separate route/endpoint triggered by the client: Violates the automatic-upload requirement; adds client complexity.
- Dispatch from the evaluate route directly: Would require the evaluate route to know about compliance, breaking separation of concerns.

## R4: PDF Generation for Sprinto Upload

**Decision**: Reuse the existing `renderEvidencePdf()` function to generate the PDF buffer for Sprinto upload.

**Rationale**: `renderEvidencePdf(evidence, tenantDisplayName)` already produces a complete A4 PDF with all evidence sections including the SHA-256 integrity hash. This is exactly what Sprinto needs as an evidence file.

**Alternatives considered**:
- Generate a separate Sprinto-specific PDF: Wasteful duplication — the existing PDF already contains all relevant evidence.
- Upload JSON directly: Not supported by Sprinto's API (requires file uploads).

## R5: Pluggable Provider Interface

**Decision**: Define a `ComplianceProvider` interface with a single `uploadEvidence` method. The orchestrator resolves the provider from tenant config and delegates. Only `SprintoProvider` is implemented initially.

**Rationale**: The interface is minimal (one method) because all providers share the same input (evidence record + tenant config) and produce the same output (success/failure with optional reference ID). Provider-specific details (GraphQL vs REST, file format, auth method) are encapsulated within each implementation.

**Alternatives considered**:
- Abstract class with shared retry logic: Retry belongs in the orchestrator, not the provider. Providers should be pure upload adapters.
- Generic webhook adapter: Too flexible — each compliance platform has unique auth, payload formats, and error semantics.
