# Storage Adapter Contract

**Branch**: `009-postgres-support` | **Date**: 2026-02-22

This feature does not introduce new API endpoints. The contract is the existing `StorageAdapter` interface that both SQLite and PostgreSQL adapters must implement identically.

## Interface Contract

```typescript
interface StorageAdapter {
  initialize(): Promise<void>;
  create<T>(tenantId: string, collection: string, data: T): Promise<T & { id: string }>;
  findById<T>(tenantId: string, collection: string, id: string): Promise<T | null>;
  findMany<T>(tenantId: string, collection: string, query: QueryFilter): Promise<T[]>;
  update<T>(tenantId: string, collection: string, id: string, data: Partial<T>): Promise<T>;
  delete(tenantId: string, collection: string, id: string): Promise<void>;
  transaction<R>(tenantId: string, fn: (tx: TransactionContext) => Promise<R>): Promise<R>;
  getMetadata(): StorageMetadata;
  close(): Promise<void>;
}
```

## Behavioral Parity Requirements

Both adapters MUST exhibit identical behavior for:

1. **CRUD operations**: Same input produces same output shape (order, fields, types)
2. **Tenant isolation**: Every method filters by `tenant_id`; cross-tenant access returns null/empty
3. **Transactions**: `transaction()` provides atomicity; rollback on error
4. **Optimistic concurrency**: Version conflict detection works identically
5. **Not-found behavior**: `findById` returns `null`; `update` throws `Error` with message containing record ID
6. **Query filters**: `where`, `orderBy`, `limit`, `offset` produce identical result sets
7. **ID generation**: UUIDs generated by the application, not the database
8. **Metadata**: `getMetadata()` returns adapter-specific name and version

## Adapter Factory Contract

```typescript
function getStorage(): StorageAdapter;
```

- Returns a shared singleton `StorageAdapter` instance
- First call creates and initializes the adapter
- Subsequent calls return the same instance
- Selection based on `DATABASE_URL` environment variable:
  - `postgres://` or `postgresql://` prefix: PostgreSQL adapter
  - Absent or other: SQLite adapter (uses `DB_PATH` or default `data/jem.db`)

## Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DATABASE_URL` | No | (none) | PostgreSQL connection string. If set with `postgres://` prefix, PostgreSQL adapter is used. |
| `DB_PATH` | No | `data/jem.db` | SQLite database file path. Used when `DATABASE_URL` is not set. |
